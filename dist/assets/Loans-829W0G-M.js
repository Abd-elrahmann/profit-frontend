import{q as We,j as e,A as E,o as $,r as i,W as Oe,a as Ge,_ as ce,B as b,as as vt,$ as ue,a0 as It,a1 as Pt,a2 as At,a3 as ie,a4 as h,a5 as kt,l as de,T as I,Y as ze,a6 as Lt,f as He,at as Et,au as Mt,ao as Y,av as se,aw as Tt,Z as Ft,m as J,n as S,ak as Ie,al as _t,O as Nt,P as $t,Q as Rt,R as Bt,a9 as Ye,U as Wt,k as W,ae as Ot,af as $e,u as Gt,H as zt,am as Re,X as Ht,ac as L,e as B}from"./index-Byloyp0V.js";import{l as Se}from"./lodash-Dqh01Uem.js";import{g as Yt}from"./bankApis-CtZ-WO8f.js";import{D as Kt}from"./DeleteModal-Du1zPAFn.js";import{T as Qt}from"./TablePagination-rGYbANAk.js";import{V as Vt}from"./Visibility--5hKivIt.js";import{A as qt}from"./AddClient-B8tgV7_K.js";import{T as Ke,a as he}from"./Tabs-D07rxUwM.js";import{A as ve}from"./Autocomplete-BtE8iJMC.js";import"./KeyboardArrowRight-nGgaUmNE.js";import"./LastPage-D5DKCjzm.js";import"./FormControlLabel-Fb32HuXN.js";import"./Popper-Rekw_xHk.js";const Ut=We(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),Zt=We(e.jsx("path",{d:"M8 5v14l11-7z"})),Xt=async(a=1,n="")=>{try{const o=n?`/api/clients/all/${a}?search=${encodeURIComponent(n)}`:`/api/clients/all/${a}`;return(await E.get(o)).data}catch(o){throw $(o),o}},Jt=async(a=1,n="")=>{try{const o=n?`/api/partners/all/${a}?search=${encodeURIComponent(n)}`:`/api/partners/all/${a}`;return(await E.get(o)).data}catch(o){throw $(o),o}},en=async a=>{try{return(await E.post("/api/loans",a)).data}catch(n){throw $(n),n}},tn=async(a,n)=>{try{return(await E.patch(`/api/loans/${a}`,n)).data}catch(o){throw $(o),o}},nn=async a=>{try{return(await E.patch(`/api/loans/${a}/activate`)).data}catch(n){throw $(n),n}},an=async a=>{try{return(await E.patch(`/api/loans/${a}/deactivate`)).data}catch(n){throw $(n),n}},rn=async(a=1,n="")=>{try{const o=n?`/api/loans/all/${a}?search=${encodeURIComponent(n)}`:`/api/loans/all/${a}`;return(await E.get(o)).data}catch(o){throw $(o),o}},sn=async a=>{try{return(await E.get(`/api/loans/${a}`)).data}catch(n){throw $(n),n}},on=async a=>{try{return(await E.delete(`/api/loans/${a}`)).data}catch(n){throw $(n),n}},ln=({onViewDetails:a,onViewInstallments:n})=>{const[o,p]=i.useState(1),[u,c]=i.useState(""),[d,v]=i.useState(null),[w,M]=i.useState(!1),T=Oe(),[F,A]=i.useState(null),[x,g]=i.useState(null),{permissions:D}=Ge(),m=(r,C)=>{A(r.currentTarget),g(C)},y=()=>{A(null),g(null)},{data:P,isLoading:_}=ce({queryKey:["loans",o,u],queryFn:()=>rn(o,u),retry:1}),N=r=>{c(r.target.value),p(1)},K=(r,C)=>{p(C+1)},k=async r=>{try{await on(r),J("تم حذف السلفة بنجاح"),T.invalidateQueries(["loans"]),M(!1),v(null)}catch(C){S(C.response?.data?.message||"حدث خطأ أثناء حذف السلفة")}},l=async r=>{try{await nn(r),J("تم تفعيل السلفة بنجاح"),T.invalidateQueries(["loans"])}catch(C){S(C.response?.data?.message||"حدث خطأ أثناء تفعيل السلفة")}},ee=async r=>{try{await an(r),J("تم إلغاء تفعيل السلفة بنجاح"),T.invalidateQueries(["loans"])}catch(C){S(C.response?.data?.message||"حدث خطأ أثناء إلغاء تفعيل السلفة")}},R=r=>{if(r.status==="PENDING"){S("يجب تفعيل السلفة أولاً لعرض الأقساط");return}n(r)},oe=r=>{switch(r){case"PENDING":return"warning";case"ACTIVE":return"success";case"COMPLETED":return"info";case"DEFAULTED":return"error";default:return"default"}},te=r=>{switch(r){case"PENDING":return"قيد المراجعة";case"ACTIVE":return"نشط";case"COMPLETED":return"مكتمل";case"DEFAULTED":return"متأخر";default:return r}},Q=r=>{switch(r){case"DAILY":return"يومي";case"WEEKLY":return"أسبوعي";case"MONTHLY":return"شهري";default:return r}};return e.jsxs(b,{sx:{display:"flex",flexDirection:"column",width:"100%",height:"100%"},children:[e.jsx(b,{sx:{p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:e.jsx(vt,{placeholder:"ابحث باسم العميل أو رقم السلفة...",value:u,onChange:N,sx:{width:"280px",borderRadius:"6px"}})}),e.jsx(ue,{sx:{flex:1,width:"100%",overflow:"hidden"},children:e.jsx(It,{sx:{height:"100%",width:"100%"},children:e.jsxs(Pt,{stickyHeader:!0,sx:{width:"100%"},children:[e.jsx(At,{children:e.jsxs(ie,{children:[e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"رقم السلفة"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"العميل"}),e.jsxs(h,{align:"center",sx:{whiteSpace:"nowrap"},children:[" ","المستثمر"]}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"الحساب البنكي"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"مبلغ السلفة"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"معدل الفائدة"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"المدة"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"النوع"}),e.jsxs(h,{align:"center",sx:{whiteSpace:"nowrap"},children:[" ","يوم الاستحقاق"]}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"الحالة"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"تاريخ البدء"}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:"الإجراءات"})]})}),e.jsx(kt,{children:_?e.jsx(ie,{children:e.jsx(h,{colSpan:12,align:"center",children:e.jsx(de,{size:20})})}):P?.data?.length===0?e.jsx(ie,{children:e.jsx(h,{colSpan:12,align:"center",children:e.jsx(I,{children:"لا توجد سلف"})})}):P?.data?.map(r=>e.jsxs(ie,{hover:!0,children:[e.jsx(h,{children:r.code}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:r.client?.name}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:r.partner?.name}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:r.bankAccount?.name}),e.jsxs(h,{align:"center",sx:{whiteSpace:"nowrap",fontWeight:"bold"},children:[r.amount?.toLocaleString()," ر.س"]}),e.jsxs(h,{align:"center",sx:{whiteSpace:"nowrap"},children:[r.interestRate,"%"]}),e.jsxs(h,{align:"center",sx:{whiteSpace:"nowrap"},children:[r.durationMonths," شهر"]}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:Q(r.type)}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:r.repaymentDay}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:e.jsx(ze,{label:te(r.status),color:oe(r.status),size:"small"})}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:Lt(r.startDate).format("DD/MM/YYYY")}),e.jsx(h,{align:"center",sx:{whiteSpace:"nowrap"},children:e.jsx(He,{size:"small",onClick:C=>m(C,r),children:e.jsx(Et,{fontSize:"small"})})})]},r.id))})]})})}),P&&e.jsx(Qt,{component:"div",count:P.total||0,page:o-1,onPageChange:K,rowsPerPage:10,rowsPerPageOptions:[10],labelDisplayedRows:({from:r,to:C,count:f})=>`عرض ${r}-${C} من ${f}`,labelRowsPerPage:"صفوف لكل صفحة:"}),e.jsx(Kt,{open:w,onClose:()=>{M(!1),v(null)},onConfirm:()=>k(d?.id),title:"حذف السلفة",message:`هل أنت متأكد من حذف سلفة العميل ${d?.client?.name}؟`,ButtonText:"حذف"}),e.jsxs(Mt,{anchorEl:F,open:!!F,onClose:y,children:[e.jsxs(Y,{onClick:()=>{a(x?.id),y()},sx:{color:"#1976D2"},children:[e.jsx(se,{children:e.jsx(Vt,{fontSize:"small",sx:{color:"#1976D2"}})}),"عرض السلفة"]}),e.jsxs(Y,{onClick:()=>{R(x),y()},sx:{color:"#2E7D32"},children:[e.jsx(se,{children:e.jsx(Tt,{fontSize:"small",sx:{color:"#2E7D32"}})}),"عرض الأقساط"]}),x?.status==="PENDING"&&D.includes("loans_Post")&&e.jsxs(Y,{onClick:()=>{l(x?.id),y()},sx:{color:"#FB8C00"},children:[e.jsx(se,{children:e.jsx(Zt,{fontSize:"small",sx:{color:"#FB8C00"}})}),"تفعيل السلفة"]}),x?.status==="ACTIVE"&&D.includes("loans_Post")&&e.jsxs(Y,{onClick:()=>{ee(x?.id),y()},sx:{color:"#8E24AA"},children:[e.jsx(se,{children:e.jsx(Ut,{fontSize:"small",sx:{color:"#8E24AA"}})}),"إلغاء تفعيل السلفة"]}),x?.status!=="ACTIVE"&&D.includes("loans_Delete")&&e.jsxs(Y,{onClick:()=>{v(x),M(!0),y()},sx:{color:"#D32F2F"},children:[e.jsx(se,{children:e.jsx(Ft,{fontSize:"small",sx:{color:"#D32F2F"}})}),"حذف السلفة"]})]})]})},pe=a=>{const n=["","واحد","اثنان","ثلاثة","أربعة","خمسة","ستة","سبعة","ثمانية","تسعة"],o=["","","عشرون","ثلاثون","أربعون","خمسون","ستون","سبعون","ثمانون","تسعون"],p=["عشرة","أحد عشر","اثنا عشر","ثلاثة عشر","أربعة عشر","خمسة عشر","ستة عشر","سبعة عشر","ثمانية عشر","تسعة عشر"],u=["","مائة","مائتان","ثلاثمائة","أربعمائة","خمسمائة","ستمائة","سبعمائة","ثمانمائة","تسعمائة"];if(a===0)return"صفر";if(a<0)return"سالب "+pe(-a);let c="";if(a>=1e6){const d=Math.floor(a/1e6);d===1?c+="مليون ":d===2?c+="مليونان ":d<11?c+=n[d]+" ملايين ":c+=pe(d)+" مليون ",a%=1e6}if(a>=1e3){const d=Math.floor(a/1e3);d===1?c+="ألف ":d===2?c+="ألفان ":d>=10&&d<=19?d===10?c+="عشرة آلاف ":c+=p[d-10]+" ألف ":d<11?c+=n[d]+" آلاف ":c+=pe(d)+" ألف ",a%=1e3}if(a>=100){const d=Math.floor(a/100);c+=u[d]+" ",a%=100}if(a>=20){const d=Math.floor(a/10),v=a%10;v>0?c+=n[v]+" و"+o[d]:c+=o[d]}else a>=10?c+=p[a-10]:a>0&&(c+=n[a]);return c.trim()},cn=()=>{const a=new Date;let o=new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura",{day:"numeric",month:"long",year:"numeric",timeZone:"Asia/Riyadh"}).format(a);return o=o.replace(/\s+/g," ").trim(),o=o.replace(" "," من "),o.includes("هـ")||(o=`${o} هـ`),{gregorianDate:`الموافق ${new Intl.DateTimeFormat("ar-SA-u-ca-gregory",{day:"numeric",month:"long",year:"numeric",timeZone:"Asia/Riyadh"}).format(a)}`,hijriDate:o}},Be=Ie.forwardRef(({loanData:a,clientData:n,templateContent:o,onContractGenerated:p,contractType:u="DEBT_ACKNOWLEDGMENT",autoGenerate:c=!1},d)=>{const[v,w]=i.useState(""),[M,T]=i.useState(!1),F=i.useCallback(async g=>{try{const D=new FormData,m=u==="DEBT_ACKNOWLEDGMENT"?`إقرار الدين_${a.id}_${Date.now()}.pdf`:`سند الأمر_${a.id}_${Date.now()}.pdf`;D.append("file",g,m);const y=u==="DEBT_ACKNOWLEDGMENT"?`/api/loans/${a.id}/upload-debt-acknowledgment`:`/api/loans/${a.id}/upload-promissory-note`;console.log("Uploading to endpoint:",y);const P=await E.post(y,D,{headers:{"Content-Type":"multipart/form-data"}});return console.log("Upload response:",P.data),P.data}catch(D){throw console.error("Error uploading PDF:",D),D}},[u,a?.id]),A=i.useCallback(async(g=v)=>{const D=g||v;if(!D){console.error("No contract HTML to generate PDF"),S("لا يوجد محتوى عقد لتحويله إلى PDF");return}try{T(!0);const m=document.createElement("div");m.id=`contract-preview-${Date.now()}`,m.style.width="210mm",m.style.minHeight="297mm",m.innerHTML=`
        <div style="
          font-family: 'Cairo', 'Noto Sans Arabic', sans-serif;
          padding: 20mm;
          background: white;
          direction: rtl;
        ">
          ${D}
        </div>
      `,document.body.appendChild(m);const y={margin:0,filename:`${u.toLowerCase()}_${n.id}_${Date.now()}.pdf`,image:{type:"jpeg",quality:1},html2canvas:{scale:3,useCORS:!0,letterRendering:!0,allowTaint:!0,logging:!0,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait",compress:!1,hotfixes:["px_scaling"]}};console.log("Generating PDF for:",u),await new Promise(N=>setTimeout(N,1e3));const P=document.getElementById(m.id),_=await _t().from(P).set(y).outputPdf("blob");return document.body.removeChild(m),await F(_),console.log("PDF generated and uploaded successfully for:",u),p&&p(_,u),_}catch(m){throw console.error("Error generating PDF:",m),S("حدث خطأ أثناء إنشاء ملف PDF"),$(m),m}finally{T(!1)}},[u,a?.id,F,p]),x=i.useCallback(async(g=c,D=null)=>{const m=D||a;if(!m||!o){console.error("Missing data:",{loanDataToUse:m,templateContent:o}),S("بيانات السلفة أو العميل أو قالب العقد غير متوفر");return}try{console.log("Generating contract:",u),console.log("Loan Data to use:",m);const{gregorianDate:y,hijriDate:P}=cn(),_=`${P}
${y}`,N=m.amount||0,K=pe(N);console.log("Amount:",N,"Amount in words:",K);let k=o.replace(/{{اسم_العميل}}/g,n.name||"").replace(/{{رقم_هوية_العميل}}/g,n.nationalId||"").replace(/{{عنوان_العميل}}/g,n.city+" - "+n.district||"").replace(/{{المبلغ_رقما}}/g,`${N?.toLocaleString("en-US")||"0"} ريال سعودي`).replace(/{{المبلغ_كتابة}}/g,`${K} ريال سعودي`).replace(/{{قيمة_السند_رقما}}/g,`${N?.toLocaleString("ar-SA")||"0"} ريال سعودي`).replace(/{{قيمة_السند_كتابة}}/g,`${K} ريال سعودي`).replace(/{{التاريخ_الهجري}}/g,P).replace(/{{التاريخ_الميلادي}}/g,y).replace(/{{تاريخ_الانشاء}}/g,_).replace(/{{تاريخ_الاستحقاق}}/g,"لدي الاطلاع").replace(/{{اسم_الدائن}}/g,"أحمد لحول").replace(/{{اسم_المدين}}/g,n.name||"").replace(/{{رقم_السند}}/g,`LOAN-${Date.now()}`).replace(/{{رقم_الإقرار}}/g,`ACK-${Date.now()}`).replace(/{{مدينة_الاصدار}}/g,"شروة - المملكة العربية السعودية").replace(/{{مدينة_الوفاء}}/g,"الرياض - المملكة العربية السعودية").replace(/{{سبب_انشاء_السند}}/g,"سلفة مالية").replace(/{{رقم_هوية_الدائن}}/g,"1234567890").replace(/{{رقم_هوية_المدين}}/g,n.nationalId||"").replace(/{{رقم_هوية_الكفيل}}/g,n.nationalId||"").replace(/{{هوية_الدائن}}/g,"1234567890").replace(/{{هوية_المدين}}/g,n.nationalId||"").replace(/{{اسم_الكفيل}}/g,n.name||"").replace(/{{هوية_الكفيل}}/g,n.nationalId||"");return console.log("Filled Template generated successfully"),console.log("Filled Template Content:",k),console.log("Contract HTML length:",k.length),w(k),g&&(console.log("Auto-generating PDF for:",u),setTimeout(async()=>{try{await A(k)}catch(l){console.error("Error in auto-generating PDF:",l)}},500)),k}catch(y){throw console.error("Error generating contract:",y),y}},[a,n,o,u,c,A]);return i.useEffect(()=>{c&&a&&n&&o&&(console.log("Auto-generating contract:",u),x(!0))},[c,a,n,o,u,x]),Ie.useImperativeHandle(d,()=>({generateContract:x,generatePDF:()=>A(v)})),c?null:e.jsx("div",{style:{width:"100%",border:"1px solid #ddd",marginBottom:"20px",padding:"10px"},children:M&&e.jsx("div",{style:{textAlign:"center",padding:"20px",backgroundColor:"#f5f5f5"},children:"جاري إنشاء PDF..."})})}),dn=({open:a,onClose:n,debtAckHtml:o,promissoryNoteHtml:p,onSaveContracts:u,loading:c=!1,clientName:d="",loanAmount:v=0})=>{const[w,M]=Ie.useState(0),T=(x,g)=>{M(g)},F=()=>{const x=document.getElementById(`contract-tab-${w}`);if(x){const g=window.open("","_blank");g.document.write(`
        <html>
          <head>
            <title>${w===0?" إقرار الدين":"سند الأمر"}</title>
            <style>
              body { 
                font-family: "Noto Sans Arabic", "Cairo", sans-serif;
                margin: 0;
                padding: 20px;
                direction: rtl;
              }
              .contract-content { 
                max-width: 900px; 
                margin: 0 auto; 
                border: 1px solid #ddd;
                padding: 30px;
                border-radius: 12px;
                background: #fff;
              }
              @media print {
                body { padding: 0; }
                .contract-content { 
                  border: none; 
                  box-shadow: none;
                  padding: 15px;
                }
              }
            </style>
          </head>
          <body>
            <div class="contract-content">
              ${x.innerHTML}
            </div>
          </body>
        </html>
      `),g.document.close(),g.focus(),setTimeout(()=>{g.print(),g.close()},500)}},A=[{name:"إقرار الدين",html:o,id:"debt-acknowledgment"},{name:"سند الأمر",html:p,id:"promissory-note"}];return e.jsxs(Nt,{open:a,onClose:n,maxWidth:"lg",fullWidth:!0,fullScreen:!0,dir:"rtl",PaperProps:{sx:{borderRadius:2,maxHeight:"100vh"}},children:[e.jsxs($t,{className:"no-print",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1,borderBottom:"1px solid #e0e0e0","@media print":{display:"none !important"}},children:[e.jsxs(b,{children:[e.jsx(I,{variant:"h6",fontWeight:"bold",children:"معاينة عقود السلفة"}),d&&e.jsxs(I,{variant:"body2",color:"text.secondary",children:["العميل: ",d," - المبلغ: ",v.toLocaleString()," ر.س"]})]}),e.jsx(He,{onClick:n,size:"small",children:e.jsx(Rt,{})})]}),e.jsx(b,{className:"no-print",sx:{borderBottom:1,borderColor:"divider","@media print":{display:"none !important"}},children:e.jsxs(Ke,{value:w,onChange:T,centered:!0,children:[e.jsx(he,{label:"إقرار الدين",sx:{fontWeight:w===0?"bold":"normal",color:w===0?"#0d40a5":"text.secondary"}}),e.jsx(he,{label:"سند الأمر",sx:{fontWeight:w===1?"bold":"normal",color:w===1?"#0d40a5":"text.secondary"}})]})}),e.jsx(Bt,{sx:{p:0,display:"flex",flexDirection:"column","@media print":{p:0,m:0}},children:A.map((x,g)=>e.jsx(b,{id:`contract-tab-${g}`,sx:{display:w===g?"block":"none","@media print":{display:"block !important",pageBreakAfter:g===0?"always":"auto"}},children:e.jsx(ue,{sx:{m:3,p:4,minHeight:"500px",bgcolor:"white",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",border:"1px solid #e0e0e0","@media print":{m:0,p:2,boxShadow:"none",border:"none",minHeight:"auto",pageBreakInside:"avoid"}},children:x.html?e.jsx(b,{dangerouslySetInnerHTML:{__html:x.html},sx:{"& *":{fontFamily:'"Noto Sans Arabic", "Cairo", "Segoe UI", sans-serif !important',lineHeight:1.8},"& h1, & h2, & h3":{textAlign:"center",color:"#1976d2",marginBottom:"20px"},"& p":{marginBottom:"15px",textAlign:"justify"},"& strong":{color:"#1976d2",fontWeight:"bold"}}}):e.jsxs(b,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"400px",flexDirection:"column",color:"text.secondary"},children:[e.jsx(I,{variant:"h6",mb:2,children:"لا يوجد محتوى للعرض"}),e.jsx(I,{variant:"body2",children:"يرجى التأكد من وجود قالب العقد وبيانات العميل"})]})})},x.id))}),e.jsx(Ye,{className:"no-print"}),e.jsxs(Wt,{className:"no-print",sx:{p:3,gap:2,flexDirection:"row-reverse",bgcolor:"#fafafa","@media print":{display:"none !important"}},children:[e.jsx(W,{onClick:n,disabled:c,variant:"outlined",sx:{minWidth:"100px",borderColor:"grey.300",color:"text.secondary","&:hover":{borderColor:"grey.400",bgcolor:"grey.50"}},children:"إغلاق"}),e.jsx(W,{variant:"outlined",startIcon:e.jsx(Ot,{sx:{marginLeft:"10px"}}),onClick:F,disabled:c||!A[w]?.html,sx:{minWidth:"120px",borderColor:"#1976d2",color:"#1976d2","&:hover":{borderColor:"#1565c0",bgcolor:"#e3f2fd"}},children:"طباعة"}),e.jsx(W,{variant:"contained",startIcon:e.jsx($e,{sx:{marginLeft:"10px"}}),onClick:()=>u(A[w].id),disabled:c||!A[w]?.html,sx:{bgcolor:"#0d40a5","&:hover":{bgcolor:"#0b3589"},minWidth:"140px"},children:c?"جاري الحفظ...":"حفظ العقد"}),e.jsx(W,{variant:"contained",startIcon:e.jsx($e,{sx:{marginLeft:"10px"}}),onClick:()=>u("both"),disabled:c||!o||!p,sx:{bgcolor:"#2e7d32","&:hover":{bgcolor:"#1b5e20"},minWidth:"180px"},children:c?"جاري الحفظ...":"حفظ كلا العقدين"})]})]})},vn=()=>{const a=Gt(),[n,o]=i.useState(0),[p,u]=i.useState(null),[c,d]=i.useState(null),[v,w]=i.useState(null),[M,T]=i.useState(""),[F,A]=i.useState(""),[x,g]=i.useState(""),[D,m]=i.useState(1),[y,P]=i.useState(1),[_,N]=i.useState(1),[K,k]=i.useState(!1),[l,ee]=i.useState({amount:"",interestRate:"",durationMonths:"",type:"",startDate:new Date().toISOString().split("T")[0],repaymentDay:""}),[R,oe]=i.useState(null),[te,Q]=i.useState([]),[r,C]=i.useState(!1),[f,ne]=i.useState(!1),xe=Oe(),[Qe,pn]=i.useState(!0),[V,ge]=i.useState(null),[Ve,qe]=i.useState(""),[Ue,Ze]=i.useState(""),[Xe,me]=i.useState(0),[Je,fe]=i.useState(!1),[Pe,Ae]=i.useState({debtAck:"",promissoryNote:""}),[et,be]=i.useState(!1),{permissions:ye}=Ge(),je=i.useRef(null),we=i.useRef(null),{data:tt,isLoading:ke}=ce({queryKey:["clients",D,M],queryFn:()=>Xt(D,M),enabled:n===1}),{data:nt,isLoading:Le}=ce({queryKey:["banks",y,F],queryFn:()=>Yt(y,F),enabled:n===1}),{data:at,isLoading:Ee}=ce({queryKey:["partners",_,x],queryFn:()=>Jt(_,x),enabled:n===1});i.useEffect(()=>{n===1&&(rt(),Me())},[n]);const rt=async()=>{try{console.log("Fetching contract templates...");const[t,s]=await Promise.all([E.get("/api/templates/DEBT_ACKNOWLEDGMENT"),E.get("/api/templates/PROMISSORY_NOTE")]);qe(t.data.content||""),Ze(s.data.content||""),console.log("Templates fetched successfully")}catch(t){console.warn("Could not fetch contract templates:",t)}};i.useEffect(()=>{n===1&&Me()},[l.amount,l.interestRate,l.durationMonths,n]);const st=Se.debounce(t=>{T(t),m(1)},500),ot=Se.debounce(t=>{A(t),P(1)},500),lt=Se.debounce(t=>{g(t),N(1)},500),it=(t,s)=>{st(s)},ct=(t,s)=>{ot(s)},dt=(t,s)=>{lt(s)},pt=(t,s)=>{u(s)},ut=(t,s)=>{d(s)},ht=(t,s)=>{w(s)},ae=t=>t?t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):"",xt=async()=>{try{if(!p||!l.amount){S("يرجى ملء بيانات العميل والسلفة أولاً");return}const t={id:`preview-${Date.now()}`,amount:parseFloat(l.amount.replace(/,/g,"")),durationMonths:parseInt(l.durationMonths),startDate:l.startDate,client:p.client},s=await je.current.generateContract(!1,t),j=await we.current.generateContract(!1,t);Ae({debtAck:s,promissoryNote:j}),fe(!0)}catch(t){console.error("Error generating preview:",t),S("حدث خطأ أثناء توليد معاينة العقود")}},gt=async t=>{try{if(!V){S("لم يتم إنشاء السلفة بعد. يرجى إنشاء السلفة أولاً");return}console.log("Saving contracts for loan:",V.id),(t==="both"||t==="debt-acknowledgment")&&(console.log("Generating debt acknowledgment..."),await je.current?.generatePDF()),(t==="both"||t==="promissory-note")&&(console.log("Generating promissory note..."),await we.current?.generatePDF()),J("تم حفظ العقود بنجاح"),ge(null),me(0),Ae({debtAck:"",promissoryNote:""}),fe(!1),Q([]),C(!1),ne(!1),o(0)}catch(s){console.error("Error saving contracts:",s),S("حدث خطأ أثناء حفظ العقود")}},Me=()=>{const t=parseFloat(l.amount.replace(/,/g,""))||0,s=parseFloat(l.interestRate)||0,j=parseInt(l.durationMonths)||0,G=l.type;if(t>0&&j>0){const U=t*(s/100),re=t+U,Z=G==="DAILY"?j*30:G==="WEEKLY"?j*4:j,z=re/Z,Ce=t/Z,De=U/Z,_e=[];let Ne=re;for(let X=1;X<=Z;X++){const H=new Date(l.startDate);G==="DAILY"?H.setDate(H.getDate()+X):G==="WEEKLY"?H.setDate(H.getDate()+X*7):(H.setMonth(H.getMonth()+X),l.repaymentDay&&H.setDate(parseInt(l.repaymentDay))),Ne-=z,_e.push({installmentNumber:X,dueDate:H,principal:Ce,interest:De,installment:z,remainingBalance:Math.max(0,Ne),status:"PENDING",paidAmount:0})}Q(_e)}else Q([])},mt=()=>{if(te.length===0)return null;const t=te.reduce((G,U)=>G+U.interest,0),s=(parseFloat(l.amount.replace(/,/g,""))||0)+t;return{monthlyInstallment:te[0]?.installment||0,totalInterest:t,totalAmount:s}},ft=async()=>{if(!p){S("يرجى اختيار عميل");return}try{be(!0);const t={clientId:p.client.id,amount:parseFloat(l.amount.replace(/,/g,"")),interestRate:parseFloat(l.interestRate),durationMonths:parseInt(l.durationMonths),type:l.type,startDate:l.startDate,repaymentDay:parseInt(l.repaymentDay),bankAccountId:c?.id||null,partnerId:v?.id||null};console.log("Creating loan with data:",t);const s=await en(t),j=s?.data?.loan||s?.loan;console.log("Loan created successfully:",j),J("تم إنشاء السلفة بنجاح"),ge({...j,client:p.client}),xe.invalidateQueries(["loans"])}catch(t){console.error("Error creating loan:",t),S(t.response?.data?.message||"حدث خطأ أثناء إنشاء السلفة")}finally{be(!1)}},Te=(t,s)=>{console.log(`Contract generated: ${s}`);const j=Xe+1;me(j)},Fe=()=>{u(null),oe(null),d(null),w(null),ee({amount:"",interestRate:"",durationMonths:"",type:"",startDate:new Date().toISOString().split("T")[0],repaymentDay:"10"}),Q([]),C(!1),ne(!1),me(0),ge(null),be(!1)},bt=async()=>{if(!R){S("لا يوجد سلفة محددة للتعديل");return}try{const t={amount:parseFloat(l.amount.replace(/,/g,"")),interestRate:parseFloat(l.interestRate),durationMonths:parseInt(l.durationMonths),type:l.type,startDate:l.startDate,repaymentDay:parseInt(l.repaymentDay),bankAccountId:c?.id||null,partnerId:v?.id||null};await tn(R.id,t),J("تم تعديل السلفة بنجاح"),Fe(),xe.invalidateQueries(["loans"]),o(0)}catch(t){S(t.response?.data?.message||"حدث خطأ أثناء تعديل السلفة")}},yt=async t=>{try{const s=await sn(t);oe(s),ne(!0),C(!1),s.client&&u({client:s.client}),s.bankAccount&&d(s.bankAccount),s.partner&&w(s.partner);const j=s.type==="DAILY"?s.durationMonths*30:s.type==="WEEKLY"?s.durationMonths*4:s.durationMonths,G=s.amount/j,U=s.interestAmount/j;let re=s.totalAmount;const Z=s.repayments.map((z,Ce)=>{const De={installmentNumber:Ce+1,dueDate:z.dueDate,principal:G,interest:U,installment:z.amount,remainingBalance:Math.max(0,re),status:z.status,paidAmount:z.paidAmount||0};return re-=z.amount,De});Q(Z),ee({amount:s.amount.toString(),interestRate:s.interestRate.toString(),durationMonths:s.durationMonths.toString(),type:s.type,startDate:s.startDate.split("T")[0],repaymentDay:s.repaymentDay?.toString()||"10"}),o(1)}catch(s){S(s.response?.data?.message||"حدث خطأ أثناء تحميل بيانات السلفة")}},jt=t=>{a(`/installments/${t.id}`)},wt=()=>{if(R.status!=="PENDING"){S("يمكن تعديل القروض في حالة 'قيد المراجعة' فقط");return}C(!0),ne(!1)},q=(t,s)=>{if(t==="amount"){const j=s.replace(/,/g,"");isNaN(j)||(s=ae(j))}ee(j=>({...j,[t]:s}))},Ct=()=>{r?bt():ft()},le=mt(),Dt=()=>p&&l.amount&&l.interestRate&&l.durationMonths&&l.repaymentDay&&l.type,St=R&&R.status==="PENDING",O=f&&R&&R.status!=="PENDING";return e.jsxs(b,{sx:{bgcolor:"#f6f6f8",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(zt,{children:[e.jsx("title",{children:"السلف"}),e.jsx("meta",{name:"description",content:"السلف"})]}),e.jsxs(b,{sx:{display:"flex",flexDirection:"row-reverse",flex:1,height:"calc(100vh - 80px)",width:"100%"},children:[n===1&&e.jsxs(b,{sx:{width:"350px",borderRight:"1px solid #ddd",bgcolor:"#fafafa",height:"100%",overflowY:"auto",flexShrink:0},children:[e.jsxs(b,{sx:{p:3,borderBottom:"1px solid #ddd",bgcolor:"#fafafa"},children:[e.jsx(I,{variant:"h6",fontWeight:"bold",mb:3,children:"محاكاة السلفة"}),le?e.jsxs(Re,{spacing:3,children:[e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(I,{color:"text.secondary",children:"القسط الشهري"}),e.jsxs(I,{color:"#0d40a5",fontWeight:"bold",fontSize:"20px",children:[ae(le.monthlyInstallment.toFixed(2))," ","ر.س"]})]}),e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(I,{color:"text.secondary",children:"إجمالي الفائدة"}),e.jsxs(I,{color:"#333",fontSize:"16px",children:[ae(le.totalInterest.toFixed(2))," ","ر.س"]})]}),e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(I,{color:"text.secondary",children:"المبلغ الإجمالي المستحق"}),e.jsxs(I,{color:"#333",fontSize:"16px",children:[ae(le.totalAmount.toFixed(2))," ","ر.س"]})]}),e.jsx(Ye,{}),e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(I,{color:"text.secondary",children:"حالة السلفة"}),e.jsx(ze,{label:f?"عرض":r?"تحت التعديل":"جديد",sx:{backgroundColor:f?"rgba(100, 100, 100, 0.2)":r?"rgba(214, 158, 46, 0.2)":"rgba(56, 161, 105, 0.2)",color:f?"#666":r?"#D69E2E":"#38A169",fontWeight:"bold"}})]})]}):e.jsx(Ht,{severity:"info",children:"أدخل بيانات السلفة لعرض المحاكاة"})]}),e.jsxs(b,{sx:{p:3},children:[e.jsx(I,{variant:"h6",fontWeight:"bold",mb:3,children:"الإجراءات"}),e.jsxs(Re,{spacing:2,children:[!f&&e.jsx(W,{variant:"contained",onClick:Ct,disabled:!Dt(),sx:{bgcolor:"#0d40a5",height:"48px",fontSize:"16px",fontWeight:"bold","&:hover":{bgcolor:"rgba(13, 64, 165, 0.9)"}},children:r?"حفظ التعديلات":"إنشاء السلفة"}),f&&St&&e.jsx(W,{variant:"contained",onClick:wt,sx:{bgcolor:"primary.main",height:"48px",fontSize:"16px",fontWeight:"bold","&:hover":{bgcolor:"primary.dark"}},children:"تعديل السلفة"}),e.jsx(W,{variant:"outlined",onClick:xt,disabled:!V,sx:{borderColor:"#0d40a5",color:"#0d40a5",height:"48px",fontSize:"16px",fontWeight:"bold","&:hover":{bgcolor:"rgba(13, 64, 165, 0.1)"}},children:"معاينة العقود"}),r&&e.jsx(W,{variant:"outlined",onClick:()=>{C(!1),ne(!0)},sx:{borderColor:"rgba(255, 0, 0, 0.5)",color:"error.main",height:"48px",fontSize:"16px",fontWeight:"bold","&:hover":{bgcolor:"rgba(255, 0, 0, 0.1)"}},children:"إلغاء التعديل"})]})]})]}),e.jsx(b,{sx:{flex:1,p:4,bgcolor:"#fff",overflowY:"auto",width:"100%"},children:e.jsxs(b,{sx:{width:"100%"},children:[e.jsx(b,{sx:{borderBottom:1,borderColor:"divider",mb:4},children:e.jsxs(Ke,{value:n,onChange:(t,s)=>{o(s),s===0&&Fe()},children:[e.jsx(he,{label:"عرض جميع السلف",sx:{fontWeight:"bold",borderBottom:n===0?"3px solid #0d40a5":"none",color:n===0?"#0d40a5":"text.secondary"}}),ye.includes("loans_Add")&&e.jsx(he,{label:f?"عرض تفاصيل السلفة":r?"تعديل السلفة":"إنشاء سلفة جديدة",sx:{fontWeight:"bold",borderBottom:n===1?"3px solid #0d40a5":"none",color:n===1?"#0d40a5":"text.secondary"}})]})}),n===0?e.jsx(b,{sx:{width:"100%",display:"flex",flexDirection:"column"},children:e.jsx(ln,{onViewDetails:yt,onViewInstallments:jt})}):e.jsxs(b,{children:[ye.includes("loans_Add")&&e.jsxs(ue,{sx:{p:4,mb:3,borderRadius:2,border:"1px solid #e5e7eb"},children:[e.jsx(I,{variant:"h6",fontWeight:"bold",color:"#333",mb:3,textAlign:"center",children:"معلومات العميل"}),e.jsxs(L,{container:!0,spacing:3,justifyContent:"center",children:[e.jsx(L,{item:!0,xs:12,md:8,children:e.jsx(ve,{options:tt?.clients||[],getOptionLabel:t=>`${t.client.name} - ${t.client.nationalId}`,value:p,onChange:pt,onInputChange:it,loading:ke,disabled:f||r,renderInput:t=>e.jsx(B,{...t,label:"اختر عميل حالي",placeholder:"ابحث بالاسم أو رقم الهوية",InputProps:{...t.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[ke?e.jsx(de,{color:"inherit",size:20}):null,t.InputProps.endAdornment]})},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"350px",backgroundColor:f||r?"#f5f5f5":"#f9fafb","&:hover fieldset":{borderColor:"#0d40a5"}}}})})}),e.jsx(L,{item:!0,xs:12,md:4,sx:{display:"flex",alignItems:"end"},children:!f&&!r&&e.jsx(W,{variant:"text",sx:{color:"#0d40a5",fontWeight:"bold",fontSize:"14px"},onClick:()=>k(!0),children:"أو إنشاء عميل جديد"})})]})]}),ye.includes("loans_Add")&&e.jsxs(ue,{sx:{p:4,mb:3,borderRadius:2,border:"1px solid #e5e7eb",backgroundColor:"#fff"},children:[e.jsx(I,{variant:"h6",fontWeight:"bold",color:"#333",mb:3,textAlign:"center",children:f?"تفاصيل السلفة":r?"تعديل تفاصيل السلفة":"حدد تفاصيل السلفة"}),e.jsxs(L,{container:!0,spacing:3,justifyContent:"center",children:[e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(B,{fullWidth:!0,type:"text",label:"مبلغ السلفة",value:ae(l.amount),onChange:t=>q("amount",t.target.value),InputLabelProps:{shrink:!0},disabled:O,onKeyDown:t=>{(t.key==="-"||t.key==="+")&&t.preventDefault()},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(B,{fullWidth:!0,type:"number",label:"معدل الفائدة السنوي (%)",value:l.interestRate,onChange:t=>q("interestRate",t.target.value),InputLabelProps:{shrink:!0},disabled:O,onKeyDown:t=>{(t.key==="-"||t.key==="+")&&t.preventDefault()},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(B,{fullWidth:!0,type:"number",label:"مدة السلفة (بالأشهر)",value:l.durationMonths,onChange:t=>q("durationMonths",t.target.value),disabled:O,onKeyDown:t=>{(t.key==="-"||t.key==="+")&&t.preventDefault()},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(B,{fullWidth:!0,type:"number",label:"عدد الأقساط",value:l.durationMonths,onChange:t=>q("durationMonths",t.target.value),disabled:O,onKeyDown:t=>{(t.key==="-"||t.key==="+")&&t.preventDefault()},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsxs(B,{fullWidth:!0,type:"text",label:"نوع السلفة",select:!0,value:l.type,onChange:t=>q("type",t.target.value),disabled:O,sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}},children:[e.jsx(Y,{value:"DAILY",children:"يومي"}),e.jsx(Y,{value:"WEEKLY",children:"أسبوعي"}),e.jsx(Y,{value:"MONTHLY",children:"شهري"})]})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(B,{fullWidth:!0,type:"number",label:"يوم السداد",value:l.repaymentDay,onChange:t=>q("repaymentDay",t.target.value),inputProps:{min:1,max:31},disabled:O,onKeyDown:t=>{(t.key==="-"||t.key==="+")&&t.preventDefault()},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(ve,{options:nt?.data||[],getOptionLabel:t=>`${t.name} - ${t.accountNumber}`,value:c,onChange:ut,onInputChange:ct,loading:Le,disabled:O,renderInput:t=>e.jsx(B,{...t,label:"اختر الحساب البنكي",placeholder:"ابحث باسم الحساب أو رقم الحساب",InputProps:{...t.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[Le?e.jsx(de,{color:"inherit",size:20}):null,t.InputProps.endAdornment]})},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})})}),e.jsx(L,{item:!0,xs:12,md:6,children:e.jsx(ve,{options:at?.partners||[],getOptionLabel:t=>t.name,value:v,onChange:ht,onInputChange:dt,loading:Ee,disabled:O,renderInput:t=>e.jsx(B,{...t,label:"اختر المستثمر",placeholder:"ابحث باسم المستثمر",InputProps:{...t.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[Ee?e.jsx(de,{color:"inherit",size:20}):null,t.InputProps.endAdornment]})},sx:{"& .MuiOutlinedInput-root":{height:"56px",width:"250px",backgroundColor:f&&!r?"#f5f5f5":"#f9fafb"}}})})})]})]})]})]})})]}),e.jsx(qt,{open:K,onClose:()=>k(!1),onSuccess:()=>{k(!1),xe.invalidateQueries(["clients"])}}),Qe&&V&&p&&e.jsxs(e.Fragment,{children:[e.jsx(Be,{ref:je,loanData:V,clientData:p?.client,templateContent:Ve,onContractGenerated:Te,contractType:"DEBT_ACKNOWLEDGMENT",autoGenerate:!1}),e.jsx(Be,{ref:we,loanData:V,clientData:p?.client,templateContent:Ue,onContractGenerated:Te,contractType:"PROMISSORY_NOTE",autoGenerate:!1}),e.jsx(dn,{open:Je,onClose:()=>fe(!1),debtAckHtml:Pe.debtAck,promissoryNoteHtml:Pe.promissoryNote,onSaveContracts:gt,loading:et,clientName:p?.client?.name,loanAmount:parseFloat(l.amount.replace(/,/g,""))||0})]})]})};export{vn as default};
//# sourceMappingURL=Loans-829W0G-M.js.map
