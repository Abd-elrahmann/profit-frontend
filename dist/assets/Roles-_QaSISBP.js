import{G as X,r as o,Z,j as e,D as _,y as J,I as B,z as ee,E as se,B as l,a as U,_ as ne,T as I,$ as z,F as ae,d as V,C as $,A as F,n as O,e as te,a0 as ie,K as re,L as oe,P as le,N as de,O as ce,Q as k,R as r,U as pe,V as ue,W as xe,X as me}from"./index-2TEkS4Tk.js";import{F as he,c as Q,a as ge,e as fe,b as q,f as w}from"./index.esm-Q7QO3LVB.js";import{F as be,l as je}from"./lodash-CxsAddGS.js";import{D as ye}from"./DeleteModal-CWdUgVUc.js";import{I as Ce}from"./InputAdornment-BbJSv7Lk.js";import{S as Ae,A as Se}from"./Search-Be34rJ9a.js";import{E as ve}from"./Edit-DJkzKNbs.js";import{T as Pe}from"./TablePagination-DstB3iTg.js";import"./KeyboardArrowRight-D-ZOxJ7W.js";import"./LastPage-TR1pquDU.js";const De=Q().shape({name:q().required("اسم الدور مطلوب").min(2,"اسم الدور يجب أن يكون حرفين على الأقل"),description:q().required("وصف الدور مطلوب").min(5,"الوصف يجب أن يكون 5 أحرف على الأقل"),permissions:fe().of(Q().shape({module:q().required(),canView:w(),canAdd:w(),canUpdate:w(),canDelete:w()}))}),R=Z(),Ie=({open:h,onClose:p,refetchRoles:P,mode:g="add",editData:x=null})=>{const m=X(),[j,y]=o.useState(!1),[W,C]=o.useState({name:"",description:"",permissions:R.map(n=>({module:n.value,canView:!1,canAdd:!1,canUpdate:!1,canDelete:!1}))});o.useEffect(()=>{if(g==="edit"&&x){const n=R.map(t=>{const a=x.permissions?.find(i=>i.module===t.value);return{module:t.value,canView:a?.canView||!1,canAdd:a?.canAdd||!1,canUpdate:a?.canUpdate||!1,canDelete:a?.canDelete||!1}});C({name:x.name||"",description:x.description||"",permissions:n})}else C({name:"",description:"",permissions:R.map(n=>({module:n.value,canView:!1,canAdd:!1,canUpdate:!1,canDelete:!1}))})},[g,x,h]);const T=async(n,{resetForm:t})=>{y(!0);try{const a={name:n.name,description:n.description,permissions:n.permissions};g==="add"?(await F.post("/api/roles",a),O("تم إضافة الدور بنجاح"),m.invalidateQueries({queryKey:["roles"]}),m.invalidateQueries({queryKey:["employees"]})):(await F.patch(`/api/roles/${x.id}`,a),O("تم تعديل الدور بنجاح"),m.invalidateQueries({queryKey:["roles"]}),m.invalidateQueries({queryKey:["employees"]})),t(),P(),p()}catch(a){te(a.response?.data?.message||"حدث خطأ أثناء العملية")}finally{y(!1)}},A=(n,t,a,i,u)=>{const d=[...n.permissions];d[a]={...d[a],[i]:u},t("permissions",d)},M=(n,t,a,i)=>{const u=n.permissions.map(d=>({...d,[a]:i}));t("permissions",u)};return e.jsxs(_,{open:h,onClose:p,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2,direction:"rtl"}},children:[e.jsxs(J,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[g==="add"?"إضافة دور جديد":"تعديل الدور",e.jsx(B,{onClick:p,size:"small",children:e.jsx(ee,{})})]}),e.jsx(he,{initialValues:W,validationSchema:De,onSubmit:T,enableReinitialize:!0,children:({values:n,errors:t,touched:a,handleChange:i,handleBlur:u,setFieldValue:d})=>e.jsxs(ge,{children:[e.jsx(se,{sx:{pb:1},children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(l,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(U,{name:"name",label:"اسم الدور",value:n.name,onChange:i,onBlur:u,error:a.name&&!!t.name,helperText:a.name&&t.name,sx:{minWidth:250,"& .MuiOutlinedInput-root":{backgroundColor:"#f9fafb",borderRadius:"6px","&:hover fieldset":{borderColor:"#0d40a5"}},"& .MuiOutlinedInput-input":{fontSize:"0.875rem"}}}),e.jsx(U,{name:"description",label:"وصف الدور",value:n.description,onChange:i,onBlur:u,error:a.description&&!!t.description,helperText:a.description&&t.description,sx:{minWidth:250,"& .MuiOutlinedInput-root":{backgroundColor:"#f9fafb",borderRadius:"6px","&:hover fieldset":{borderColor:"#0d40a5"}},"& .MuiOutlinedInput-input":{fontSize:"0.875rem"}}})]}),e.jsx(ne,{}),e.jsxs(l,{children:[e.jsx(I,{variant:"h6",sx:{mb:2,fontWeight:"bold"},children:"الصلاحيات"}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"1fr repeat(4, auto)",gap:1,alignItems:"center",mb:2,p:1,bgcolor:"#f5f5f5",borderRadius:1},children:[e.jsx(I,{variant:"subtitle2",sx:{fontWeight:"bold"},children:"الصلاحيات"}),["عرض","إضافة","تعديل","حذف"].map((c,b)=>e.jsxs(l,{sx:{textAlign:"center"},children:[e.jsx(I,{variant:"subtitle2",sx:{fontSize:"0.75rem",fontWeight:"bold"},children:c}),e.jsx(z,{size:"small",onChange:S=>M(n,d,["canView","canAdd","canUpdate","canDelete"][b],S.target.checked)})]},c))]}),e.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1},children:n.permissions.map((c,b)=>{const S=R.find(f=>f.value===c.module);return e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"1fr repeat(4, auto)",gap:1,alignItems:"center",p:1,borderRadius:1,bgcolor:b%2===0?"transparent":"#f9f9f9"},children:[e.jsx(I,{variant:"body2",sx:{fontWeight:"500"},children:S?.label||c.module}),["canView","canAdd","canUpdate","canDelete"].map(f=>e.jsx(l,{sx:{display:"flex",justifyContent:"center"},children:e.jsx(be,{control:e.jsx(z,{size:"small",checked:c[f],onChange:E=>A(n,d,b,f,E.target.checked)}),label:""})},f))]},c.module)})})]})]})}),e.jsxs(ae,{sx:{px:3,py:2,display:"flex",justifyContent:"center",alignItems:"center",gap:2,flexDirection:"row-reverse"},children:[e.jsx(V,{onClick:p,variant:"outlined",color:"inherit",disabled:j,children:"إلغاء"}),e.jsx(V,{type:"submit",variant:"contained",disabled:j,sx:{bgcolor:"#1E40AF","&:hover":{bgcolor:"#1E3A8A"},minWidth:120},children:j?e.jsx($,{size:24,color:"inherit"}):g==="add"?"إضافة":"تعديل"})]})]})})]})},we=async(h=1,p="")=>(await F.get(`/api/roles?name=${p}`)).data;function Ve(){const[h,p]=o.useState(0),[P,g]=o.useState(10),[x,m]=o.useState(!1),[j,y]=o.useState("add"),[W,C]=o.useState(null),[T,A]=o.useState(!1),[M,n]=o.useState(null),[t,a]=o.useState(""),{permissions:i}=ie(),{data:u,isLoading:d,refetch:c}=re({queryKey:["roles",h+1,t],queryFn:()=>we(h+1,t),keepPreviousData:!0,staleTime:1e3*60*5,retry:1}),b=je.debounce(s=>{a(s)},500),S=s=>{b(s.target.value)},f=(s,v)=>{p(v)},E=s=>{g(parseInt(s.target.value,10)),p(0)},K=s=>{C(s),y("edit"),m(!0)},Y=()=>{C(null),y("add"),m(!0)},H=async s=>{try{await F.delete(`/api/roles/${s}`),c(),A(!1),n(null)}catch(v){console.error("Error deleting role:",v)}},L=s=>{n(s),A(!0)},G=s=>s?s.reduce((v,D)=>{const N=D.canView||D.canAdd||D.canUpdate||D.canDelete;return v+(N?1:0)},0):0;return e.jsxs(l,{sx:{bgcolor:"#FFFFFF",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(l,{sx:{p:5},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4,flexWrap:"wrap",gap:2},children:[e.jsx(U,{placeholder:"البحث عن دور بالاسم",variant:"outlined",onChange:S,sx:{flex:1,bgcolor:"#F3F4F6",borderRadius:2,"& fieldset":{border:"none"}},InputProps:{startAdornment:e.jsx(Ce,{position:"start",children:e.jsx(Ae,{sx:{color:"gray"}})})}}),i.includes("Add")&&e.jsx(V,{variant:"contained",startIcon:e.jsx(Se,{}),onClick:Y,sx:{bgcolor:"#1E40AF","&:hover":{bgcolor:"#1E3A8A"},fontWeight:"bold"},children:"إضافة دور جديد"})]}),e.jsxs(oe,{component:le,sx:{borderRadius:2},children:[e.jsxs(de,{stickyHeader:!0,children:[e.jsx(ce,{sx:{bgcolor:"#F3F4F6"},children:e.jsxs(k,{children:[e.jsx(r,{align:"center",sx:{fontWeight:"bold"},children:"اسم الدور"}),e.jsx(r,{align:"center",sx:{fontWeight:"bold"},children:"الوصف"}),e.jsx(r,{align:"center",sx:{fontWeight:"bold"},children:"عدد الصلاحيات"}),e.jsx(r,{align:"center",sx:{fontWeight:"bold"},children:"تاريخ الإنشاء"}),e.jsx(r,{align:"center",sx:{fontWeight:"bold"},children:"الإجراءات"})]})}),e.jsx(pe,{children:d?e.jsx(k,{children:e.jsx(r,{colSpan:5,align:"center",children:e.jsx($,{})})}):u?.roles?.map(s=>e.jsxs(k,{hover:!0,children:[e.jsx(r,{align:"center",sx:{fontWeight:"bold"},children:s.name}),e.jsx(r,{align:"center",sx:{color:"gray"},children:s.description}),e.jsx(r,{align:"center",children:e.jsx(ue,{label:`${G(s.permissions)} صلاحية`,sx:{bgcolor:"rgba(16,185,129,0.1)",color:"#10B981",fontWeight:"bold"}})}),e.jsx(r,{align:"center",sx:{color:"gray"},children:xe(s.createdAt).format("DD/MM/YYYY")}),e.jsxs(r,{align:"center",sx:{fontWeight:"bold"},children:[i.includes("Update")&&e.jsx(B,{color:"primary",onClick:()=>K(s),children:e.jsx(ve,{})}),i.includes("Delete")&&e.jsx(B,{color:"error",onClick:()=>L(s.id),children:e.jsx(me,{})})]})]},s.id))})]}),e.jsx(Pe,{component:"div",count:u?.total||0,page:h,onPageChange:f,rowsPerPage:P,onRowsPerPageChange:E,labelRowsPerPage:"عدد العناصر في الصفحة"})]})]}),e.jsx(Ie,{open:x,onClose:()=>m(!1),refetchRoles:c,mode:j,editData:W}),e.jsx(ye,{open:T,onClose:()=>A(!1),onConfirm:()=>H(M),title:"حذف الدور",message:"هل أنت متأكد من حذف هذا الدور؟",ButtonText:"حذف"})]})}export{Ve as default};
//# sourceMappingURL=Roles-_QaSISBP.js.map
