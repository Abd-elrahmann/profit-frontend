import{q as O,j as e,r as y,a$ as V,b0 as G,B as g,T as l,am as P,e as $,l as L,a6 as m,k as Y,A as k,ah as q,_ as X,H as Q,$ as I,ac as D,Y as T,a0 as R,a1 as B,a2 as U,a3 as E,a4 as d,a5 as z,X as J,C,b as W,m as _,n as H}from"./index-Byloyp0V.js";import{A as K}from"./Autocomplete-BtE8iJMC.js";import{D as N}from"./DatePicker-Cl157OL-.js";import{S as F}from"./Search-DKotboAf.js";import{a as Z,u as w,w as ee,P as te,T as ne}from"./xlsx-CBXfoY1t.js";import{F as re}from"./FileSaver.min-CLobENq5.js";import"./Popper-Rekw_xHk.js";const oe=O(e.jsx("path",{d:"M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8m-6 8c0-1.65.67-3.15 1.76-4.24L6.34 7.34C4.9 8.79 4 10.79 4 13c0 4.08 3.05 7.44 7 7.93v-2.02c-2.83-.48-5-2.94-5-5.91"})),ae={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"450px",sm:"600px",md:"700px",lg:"600px"},bgcolor:"background.paper",border:"1px solid var(--primary)",boxShadow:24,p:4,borderRadius:3},se=async(r=1,c="")=>{const t=new URLSearchParams;return c&&t.append("search",c),t.append("limit","10"),(await k.get(`/api/accounts/all/${r}${t.toString()?`?${t.toString()}`:""}`)).data},ie=async r=>(await k.get(`/api/accounts/all/1?search=${encodeURIComponent(r)}&limit=10`)).data,ce=({open:r,onClose:c,onSearch:t})=>{const[x,p]=y.useState([]),[n,s]=y.useState([]),[j,b]=y.useState(!1),[f,S]=y.useState("");y.useEffect(()=>{(async()=>{if(r){b(!0);try{const u=await se(1,"");p(u.accounts||[]),s(u.accounts||[])}catch(u){console.error("Error fetching accounts:",u),p([]),s([])}finally{b(!1)}}})()},[r]),y.useEffect(()=>{const u=setTimeout(async()=>{if(f.trim().length>2){b(!0);try{const M=await ie(f);s(M.accounts||[])}catch(M){console.error("Search error:",M),s([])}finally{b(!1)}}else s(x)},500);return()=>clearTimeout(u)},[f,x]);const o=V({initialValues:{account:null,fromDate:null,toDate:null},onSubmit:i=>{t({account:i.account,fromDate:i.fromDate?i.fromDate.format("YYYY-MM-DD"):null,toDate:i.toDate?i.toDate.format("YYYY-MM-DD"):null}),c()}}),h=()=>{o.resetForm(),S("")},v=(i,u)=>{o.setFieldValue("account",u)},A=(i,u)=>{S(u)},a=f.trim().length>2?n:x;return e.jsx(G,{open:r,onClose:c,"aria-labelledby":"general-ledger-search-title",children:e.jsxs(g,{sx:ae,children:[e.jsx(l,{id:"general-ledger-search-title",variant:"h6",component:"h2",sx:{fontSize:"1.3rem",fontWeight:"600",marginBottom:"20px",color:"primary.main",textAlign:"center"},children:"بحث في دفتر الأستاذ"}),e.jsx("form",{onSubmit:o.handleSubmit,children:e.jsxs(P,{spacing:3,children:[e.jsx(K,{id:"account-autocomplete",options:a,value:o.values.account,onChange:v,onInputChange:A,getOptionLabel:i=>`${i.code} - ${i.name}`,renderOption:(i,u)=>e.jsx(g,{component:"li",...i,sx:{py:1},children:e.jsx(g,{sx:{display:"flex",justifyContent:"space-between",width:"100%"},children:e.jsx(g,{children:e.jsxs(l,{variant:"body1",fontWeight:"500",children:[u.code," - ",u.name]})})})}),renderInput:i=>e.jsx($,{...i,label:"اختر الحساب",placeholder:"ابحث باسم الحساب أو الكود...",variant:"outlined",required:!0,error:o.touched.account&&!o.values.account,helperText:o.touched.account&&!o.values.account?"الحساب مطلوب":"",InputProps:{...i.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[j?e.jsx(L,{size:20}):null,i.InputProps.endAdornment]})}}),loading:j,noOptionsText:"لا توجد حسابات مطابقة"}),e.jsx(N,{label:"من تاريخ",value:o.values.fromDate,onChange:i=>o.setFieldValue("fromDate",i),maxDate:o.values.toDate||m(),renderInput:i=>e.jsx($,{...i,fullWidth:!0,variant:"outlined"})}),e.jsx(N,{label:"إلى تاريخ",value:o.values.toDate,onChange:i=>o.setFieldValue("toDate",i),minDate:o.values.fromDate||m().startOf("month"),maxDate:m(),renderInput:i=>e.jsx($,{...i,fullWidth:!0,variant:"outlined"})}),e.jsxs(P,{direction:"row",gap:2,children:[e.jsx(Y,{variant:"outlined",fullWidth:!0,onClick:h,startIcon:e.jsx(oe,{sx:{marginLeft:"10px"}}),sx:{color:"text.secondary",borderColor:"text.secondary","&:hover":{borderColor:"text.primary",bgcolor:"action.hover"}},children:"إعادة تعيين"}),e.jsx(Y,{variant:"contained",fullWidth:!0,type:"submit",disabled:!o.values.account,startIcon:e.jsx(F,{sx:{marginLeft:"10px"}}),sx:{bgcolor:"primary.main","&:hover":{bgcolor:"primary.dark"},minWidth:120,"&:disabled":{bgcolor:"action.disabled",color:"text.disabled"}},children:"بحث"})]})]})})]})})},le=r=>{try{r.addFont("/assets/fonts/Amiri-Regular.ttf","Amiri","normal"),r.addFont("/assets/fonts/Amiri-Bold.ttf","Amiri","bold")}catch(c){console.warn("Arabic fonts not found, using default fonts",c)}},de=async(r,c,t)=>new Promise((x,p)=>{try{const n=new q;if(le(n),n.setProperties({title:`دفتر الأستاذ - ${c.name}`,subject:"دفتر الأستاذ العام",author:"نظام إدارة السلف",keywords:"دفتر, أستاذ, محاسبة, سلف",creator:"نظام إدارة السلف"}),n.setFont("Amiri","normal"),n.setFontSize(16),n.text("دفتر الأستاذ العام",105,20,{align:"center"}),n.setFontSize(12),n.text(`الحساب: ${c.name} (${c.code})`,105,30,{align:"center"}),t.fromDate||t.toDate){const o=t.fromDate?m(t.fromDate).format("DD/MM/YYYY"):"بداية",h=t.toDate?m(t.toDate).format("DD/MM/YYYY"):"نهاية";n.text(`الفترة: من ${o} إلى ${h}`,105,37,{align:"center"})}n.setFontSize(10);let s=50;n.text(`الرصيد الافتتاحي: ${r.openingBalance?.toLocaleString("en-US")||0} ريال`,14,s),s+=7,n.text(`إجمالي المدين: ${r.totalDebit?.toLocaleString("en-US")||0} ريال`,14,s),s+=7,n.text(`إجمالي الدائن: ${r.totalCredit?.toLocaleString("en-US")||0} ريال`,14,s),s+=7,n.text(`الرصيد الختامي: ${r.closingBalance?.toLocaleString("en-US")||0} ريال`,14,s),s+=7,n.text(`عدد القيود: ${r.journals?.length||0}`,14,s),s+=15;const j=r.journals?.map(o=>[o.balance.toLocaleString("en-US")+" ريال",o.credit>0?o.credit.toLocaleString("en-US")+" ريال":"0",o.debit>0?o.debit.toLocaleString("en-US")+" ريال":"0",o.description||"-",o.reference||"-",m(o.date).format("DD/MM/YYYY HH:mm")])||[];Z(n,{startY:s,head:[["الرصيد","دائن","مدين","الوصف","المرجع","التاريخ"]],body:j,theme:"grid",tableLineColor:[0,0,0],tableLineWidth:.1,styles:{font:"Amiri",fontStyle:"normal",fontSize:7,cellPadding:2,lineColor:[0,0,0],lineWidth:.1,halign:"center"},headStyles:{fillColor:[13,64,165],textColor:255,fontStyle:"bold",fontSize:8,halign:"center"},bodyStyles:{halign:"center"},columnStyles:{0:{cellWidth:25},1:{cellWidth:20},2:{cellWidth:20},3:{cellWidth:50},4:{cellWidth:25},5:{cellWidth:25}},margin:{top:s,right:10,left:10},tableWidth:"wrap",horizontalPageBreak:!0,pageBreak:"auto"});const f=n.internal.getNumberOfPages();for(let o=1;o<=f;o++)n.setPage(o),n.setFontSize(8),n.text(`صفحة ${o} من ${f}`,n.internal.pageSize.width/2,n.internal.pageSize.height-10,{align:"center"}),n.text(`تم الإنشاء في: ${new Date().toLocaleDateString("ar-SA")}`,n.internal.pageSize.width-10,n.internal.pageSize.height-10,{align:"left"});const S=`دفتر_الأستاذ_${c.name}_${m().format("YYYY-MM-DD")}.pdf`;n.save(S),x()}catch(n){console.error("PDF export error:",n.message),p(n)}}),xe=async(r,c,t)=>{try{const x=w.book_new(),p=[["دفتر الأستاذ العام"],[`الحساب: ${c.name}`],[`كود الحساب: ${c.code}`],[`نوع الحساب: ${pe(c.type)}`],[""],["الرصيد الافتتاحي",r.openingBalance||0],["إجمالي المدين",r.totalDebit||0],["إجمالي الدائن",r.totalCredit||0],["الرصيد الختامي",r.closingBalance||0],["عدد القيود",r.journals?.length||0],[""]];if(t.fromDate||t.toDate){const h=t.fromDate?m(t.fromDate).format("DD/MM/YYYY"):"بداية",v=t.toDate?m(t.toDate).format("DD/MM/YYYY"):"نهاية";p.splice(4,0,[`الفترة: من ${h} إلى ${v}`])}const n=r.journals?.map(h=>({التاريخ:m(h.date).format("DD/MM/YYYY HH:mm"),المرجع:h.reference||"-",الوصف:h.description||"-",مدين:h.debit>0?h.debit:0,دائن:h.credit>0?h.credit:0,الرصيد:h.balance,الحالة:he(h.status),"المرحل بواسطة":h.postedBy||"غير محدد"}))||[],s=w.aoa_to_sheet(p),j=w.json_to_sheet(n),b=[{wch:20},{wch:15},{wch:40},{wch:12},{wch:12},{wch:15},{wch:10},{wch:15}];j["!cols"]=b,w.book_append_sheet(x,s,"ملخص"),w.book_append_sheet(x,j,"القيود");const f=ee(x,{bookType:"xlsx",type:"array",bookSST:!1}),S=new Blob([f],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=`دفتر_الأستاذ_${c.name}_${m().format("YYYY-MM-DD")}.xlsx`;re.saveAs(S,o)}catch(x){throw console.error("Excel export error:",x.message),x}},he=r=>({POSTED:"مرحل",DRAFT:"مسودة",PENDING:"قيد الانتظار",CANCELLED:"ملغي"})[r]||r,pe=r=>({ASSET:"أصول",LIABILITY:"خصوم",EQUITY:"حقوق ملكية",REVENUE:"إيرادات",EXPENSE:"مصروفات"})[r]||r,me=async(r,c=null,t=null)=>{const x=new URLSearchParams;c&&x.append("fromDate",c),t&&x.append("toDate",t);const p=x.toString();return(await k.get(`/api/accounts/${r}${p?`?${p}`:""}`)).data};function ve(){const[r,c]=y.useState(!1),[t,x]=y.useState(null),[p,n]=y.useState({pdf:!1,excel:!1}),{data:s,isLoading:j,error:b}=X({queryKey:["account-ledger",t?.account?.id,t?.fromDate,t?.toDate],queryFn:()=>t?me(t.account.id,t.fromDate,t.toDate):null,enabled:!!t,retry:1}),f=a=>{x(a)},S=async()=>{if(!(!s||!t)){n(a=>({...a,pdf:!0}));try{await de(s,t.account,t),_("تم تصدير دفتر الأستاذ بصيغة PDF بنجاح")}catch(a){H("حدث خطأ أثناء تصدير PDF"),console.error("PDF Export Error:",a)}finally{n(a=>({...a,pdf:!1}))}}},o=async()=>{if(!(!s||!t)){n(a=>({...a,excel:!0}));try{await xe(s,t.account,t),_("تم تصدير دفتر الأستاذ بصيغة Excel بنجاح")}catch(a){H("حدث خطأ أثناء تصدير Excel"),console.error("Excel Export Error:",a)}finally{n(a=>({...a,excel:!1}))}}},h=s?.journals?.reduce((a,i)=>a+(i.debit||0),0)||0,v=s?.journals?.reduce((a,i)=>a+(i.credit||0),0)||0,A=s?.account?.balance||0;return e.jsxs(g,{sx:{minHeight:"100vh"},children:[e.jsxs(Q,{children:[e.jsx("title",{children:"دفتر الأستاذ العام"}),e.jsx("meta",{name:"description",content:"دفتر الأستاذ العام للمحاسبة"})]}),e.jsx(g,{sx:{p:3,pb:0},children:e.jsxs(I,{sx:{p:2,borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)"},children:[e.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(g,{sx:{display:"flex",gap:2},children:[e.jsx(Y,{variant:"outlined",startIcon:e.jsx(te,{}),onClick:S,disabled:p.pdf||!s,sx:{borderColor:"#d32f2f",color:"#d32f2f","&:hover":{borderColor:"#b71c1c",backgroundColor:"rgba(211, 47, 47, 0.04)"}},children:p.pdf?e.jsx(L,{size:20,sx:{color:"#d32f2f"}}):"PDF"}),e.jsx(Y,{variant:"outlined",startIcon:e.jsx(ne,{}),onClick:o,disabled:p.excel||!s,sx:{borderColor:"#2e7d32",color:"#2e7d32","&:hover":{borderColor:"#1b5e20",backgroundColor:"rgba(46, 125, 50, 0.04)"}},children:p.excel?e.jsx(L,{size:20,sx:{color:"#2e7d32"}}):"Excel"})]}),e.jsx(Y,{variant:"contained",startIcon:e.jsx(F,{sx:{marginLeft:"10px"}}),onClick:()=>c(!0),sx:{bgcolor:"primary.main","&:hover":{bgcolor:"primary.dark"},minWidth:120},children:"بحث"})]}),t&&e.jsx(g,{sx:{mt:2,p:2,borderRadius:1},children:e.jsxs(D,{container:!0,spacing:2,alignItems:"center",children:[e.jsxs(D,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",fontWeight:"bold",color:"primary.main",children:t.account.name}),e.jsxs(l,{variant:"body2",color:"text.secondary",children:[t.account.code," - ",ge(t.account.type)]})]}),e.jsx(D,{item:!0,xs:12,md:6,children:e.jsxs(g,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(T,{label:`من: ${t.fromDate?m(t.fromDate).format("DD/MM/YYYY"):"البداية"}`,variant:"outlined"}),e.jsx(T,{label:`إلى: ${t.toDate?m(t.toDate).format("DD/MM/YYYY"):"النهاية"}`,variant:"outlined"})]})})]})})]})}),e.jsx(g,{sx:{p:3},children:t?j?e.jsx(g,{sx:{display:"flex",justifyContent:"center",p:6},children:e.jsx(L,{size:60})}):b?e.jsxs(J,{severity:"error",sx:{borderRadius:2},children:["حدث خطأ في تحميل بيانات الحساب: ",b.message]}):e.jsxs(g,{children:[e.jsxs(D,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(D,{item:!0,xs:12,md:3,children:e.jsx(C,{sx:{borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)"},children:e.jsxs(W,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",fontWeight:"bold",color:"primary.main",children:h.toLocaleString("en-US")}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"إجمالي المدين"})]})})}),e.jsx(D,{item:!0,xs:12,md:3,children:e.jsx(C,{sx:{borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)"},children:e.jsxs(W,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",fontWeight:"bold",color:"success.main",children:v.toLocaleString("en-US")}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"إجمالي الدائن"})]})})}),e.jsx(D,{item:!0,xs:12,md:3,children:e.jsx(C,{sx:{borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)"},children:e.jsxs(W,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",fontWeight:"bold",color:"warning.main",children:s.journals?.length||0}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"عدد القيود"})]})})}),e.jsx(D,{item:!0,xs:12,md:3,children:e.jsx(C,{sx:{borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)"},children:e.jsxs(W,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",fontWeight:"bold",color:A>=0?"primary.main":"error.main",children:A.toLocaleString("en-US")}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"الرصيد الختامي"})]})})})]}),e.jsxs(I,{sx:{borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)",overflow:"hidden"},children:[e.jsx(R,{children:e.jsxs(B,{children:[e.jsx(U,{children:e.jsxs(E,{children:[e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"150px"},children:"التاريخ"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"المرجع"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",minWidth:"200px"},children:"الوصف"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"مدين"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"دائن"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"الرصيد"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"100px"},children:"الحالة"})]})}),e.jsx(z,{children:s.journals?.map(a=>e.jsxs(E,{hover:!0,children:[e.jsxs(d,{align:"center",children:[e.jsx(l,{variant:"body2",children:m(a.date).format("DD/MM/YYYY")}),e.jsx(l,{variant:"caption",color:"text.secondary",children:m(a.date).format("HH:mm")})]}),e.jsx(d,{align:"center",children:e.jsx(l,{variant:"body2",fontWeight:"500",color:"primary",children:a.reference})}),e.jsxs(d,{align:"center",children:[e.jsx(l,{variant:"body2",sx:{mb:.5},children:a.description}),a.postedBy&&e.jsxs(l,{variant:"caption",color:"text.secondary",children:["بواسطة: ",a.postedBy]})]}),e.jsx(d,{align:"center",children:a.debit>0?e.jsx(l,{variant:"body2",fontWeight:"bold",color:"success.main",children:a.debit.toLocaleString("en-US")}):e.jsx(l,{variant:"body2",color:"text.secondary",children:"0"})}),e.jsx(d,{align:"center",children:a.credit>0?e.jsx(l,{variant:"body2",fontWeight:"bold",color:"error.main",children:a.credit.toLocaleString("en-US")}):e.jsx(l,{variant:"body2",color:"text.secondary",children:"0"})}),e.jsx(d,{align:"center",children:e.jsx(l,{variant:"body2",fontWeight:"bold",color:a.balance>=0?"primary.main":"error.main",children:a.balance.toLocaleString("en-US")})}),e.jsx(d,{align:"center",children:e.jsx(T,{label:a.status==="POSTED"?"مرحل":"مسودة",size:"small",color:a.status==="POSTED"?"success":"default",variant:"outlined",sx:{fontWeight:"500"}})})]},a.id))})]})}),(!s.journals||s.journals.length===0)&&e.jsxs(g,{sx:{textAlign:"center",py:6},children:[e.jsx(l,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"لا توجد قيود في الفترة المحددة"}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"لم يتم تسجيل أي قيود للحساب في الفترة المحددة"})]})]})]}):e.jsx(I,{sx:{borderRadius:2,boxShadow:"0 2px 12px rgba(0,0,0,0.1)",overflow:"hidden"},children:e.jsx(R,{children:e.jsxs(B,{children:[e.jsx(U,{children:e.jsxs(E,{children:[e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"150px"},children:"التاريخ"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"المرجع"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",minWidth:"200px"},children:"الوصف"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"مدين"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"دائن"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"120px"},children:"الرصيد"}),e.jsx(d,{align:"center",sx:{fontWeight:"bold",width:"100px"},children:"الحالة"})]})}),e.jsx(z,{children:e.jsx(E,{children:e.jsxs(d,{colSpan:7,align:"center",sx:{py:8},children:[e.jsx(F,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(l,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"دفتر الأستاذ العام"}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"اختر حساباً من خلال زر البحث لعرض القيود المحاسبية"})]})})})]})})})}),e.jsx(ce,{open:r,onClose:()=>c(!1),onSearch:f})]})}const ge=r=>({ASSET:"أصول",LIABILITY:"خصوم",EQUITY:"حقوق ملكية",REVENUE:"إيرادات",EXPENSE:"مصروفات"})[r]||r;export{ve as default};
//# sourceMappingURL=GeneralLedger-k85rAX6Q.js.map
