# نظام توليد عقود المضاربة التلقائي

## نظرة عامة

تم تطوير نظام متكامل لتوليد عقود المضاربة تلقائياً عند إضافة مستثمر جديد. النظام يقوم بالخطوات التالية:

1. **إضافة مستثمر جديد** → يفتح مودال إدخال البيانات
2. **حفظ البيانات** → يتم حفظ المستثمر في قاعدة البيانات
3. **توليد العقد** → يتم استبدال المتغيرات في قالب العقد ببيانات المستثمر
4. **معاينة العقد** → يتم عرض العقد للمراجعة قبل الحفظ
5. **تحويل إلى PDF** → يتم تحويل العقد إلى ملف PDF
6. **رفع إلى الخادم** → يتم رفع الملف وحفظه مع بيانات المستثمر

## المكونات الرئيسية

### 1. ContractGenerator
**الملف:** `src/components/ContractGenerator.jsx`

مكون رئيسي لتوليد العقود وتحويلها إلى PDF.

**الميزات:**
- استبدال المتغيرات في القوالب ببيانات المستثمر
- تحويل الأرقام إلى كلمات باللغة العربية
- إضافة التواريخ الهجرية والميلادية تلقائياً
- تحويل HTML إلى PDF باستخدام html2pdf.js
- رفع الملف إلى الخادم

**الاستخدام:**
```jsx
<ContractGenerator
  ref={contractGeneratorRef}
  investorData={investorData}
  templateContent={templateContent}
  onContractGenerated={handleContractGenerated}
  contractType="MUDARABAH"
/>
```

### 2. ContractPreview
**الملف:** `src/components/ContractPreview.jsx`

مكون لعرض معاينة العقد قبل التحويل إلى PDF.

**الميزات:**
- عرض العقد بتنسيق جميل
- إمكانية الطباعة
- إمكانية الحفظ كـ PDF
- واجهة مستخدم باللغة العربية

### 3. FileUploadDropzone
**الملف:** `src/components/FileUploadDropzone.jsx`

مكون لرفع الملفات باستخدام السحب والإفلات.

**الميزات:**
- دعم السحب والإفلات
- دعم أنواع ملفات متعددة (PDF, JPG, PNG)
- شريط تقدم الرفع
- التحقق من حجم ونوع الملف
- عرض الملفات المرفوعة

### 4. AddInvestor Modal (محدث)
**الملف:** `src/components/modals/AddInvestor.jsx`

تم تحديث مودال إضافة المستثمر لدعم توليد العقود.

**التحديثات:**
- إضافة خيار "توليد عقد المضاربة تلقائياً"
- جلب قالب العقد من الخادم
- تشغيل توليد العقد بعد حفظ المستثمر
- دمج ContractGenerator

## المتغيرات المدعومة في القوالب

### البيانات الشخصية
- `{{اسم_العميل}}` - اسم المستثمر
- `{{رقم_هوية_العميل}}` - رقم الهوية الوطنية
- `{{عنوان_العميل}}` - عنوان المستثمر
- `{{هاتف_العميل}}` - رقم الهاتف
- `{{بريد_العميل}}` - البريد الإلكتروني

### البيانات المالية
- `{{رأس_المال}}` - مبلغ رأس المال بالأرقام
- `{{رأس_المال_كتابة}}` - مبلغ رأس المال بالكلمات
- `{{المبلغ_رقما}}` - نفس رأس المال (للتوافق)
- `{{المبلغ_كتابة}}` - نفس رأس المال بالكلمات
- `{{نسبة_أرباح_المنشأة}}` - نسبة أرباح المنشأة
- `{{نسبة_أرباح_المستثمر}}` - نسبة أرباح المستثمر

### التواريخ
- `{{التاريخ_الهجري}}` - التاريخ الحالي بالتقويم الهجري
- `{{التاريخ_الميلادي}}` - التاريخ الحالي بالتقويم الميلادي
- `{{تاريخ_العقد_هجري}}` - تاريخ العقد بالهجري
- `{{تاريخ_العقد_ميلادي}}` - تاريخ العقد بالميلادي

### بيانات الشركة
- `{{اسم_رب_المال}}` - اسم الشركة
- `{{هوية_رب_المال}}` - رقم هوية الشركة
- `{{عنوان_رب_المال}}` - عنوان الشركة
- `{{مدينة_العقد}}` - مدينة إبرام العقد

## كيفية الاستخدام

### 1. إضافة مستثمر جديد
1. اذهب إلى صفحة "إدارة المستثمرين"
2. انقر على "إضافة مستثمر جديد"
3. املأ البيانات المطلوبة
4. تأكد من تفعيل "توليد عقد المضاربة تلقائياً"
5. انقر "إضافة"

### 2. مراجعة العقد
1. سيظهر العقد في نافذة المعاينة
2. راجع البيانات والتأكد من صحتها
3. يمكنك طباعة العقد أو حفظه كـ PDF

### 3. حفظ العقد
1. انقر "حفظ كـ PDF"
2. سيتم تحويل العقد إلى PDF ورفعه للخادم
3. سيظهر العقد في تاب "المستندات" للمستثمر

### 4. رفع مستندات إضافية
1. اذهب إلى تفاصيل المستثمر
2. انقر على تاب "المستندات"
3. استخدم منطقة السحب والإفلات لرفع ملفات إضافية

## التخصيص

### تعديل قوالب العقود
1. اذهب إلى صفحة "قوالب العقود"
2. اختر "عقد المضاربة"
3. عدل النص حسب الحاجة
4. استخدم المتغيرات المتاحة
5. احفظ التغييرات

### إضافة متغيرات جديدة
لإضافة متغيرات جديدة، عدل في ملف `ContractGenerator.jsx`:

```javascript
let filledTemplate = templateContent
  .replace(/{{متغير_جديد}}/g, investorData.newField || '')
  // ... باقي المتغيرات
```

## المتطلبات التقنية

### المكتبات المطلوبة
- `html2pdf.js` - لتحويل HTML إلى PDF
- `react-dropzone` - لرفع الملفات
- `@mui/material` - للواجهة

### تثبيت المكتبات
```bash
npm install html2pdf.js react-dropzone
```

## الأمان والأداء

### الأمان
- التحقق من نوع وحجم الملفات
- تنظيف المدخلات قبل الاستخدام
- رفع الملفات عبر API محمي

### الأداء
- تحميل القوالب عند الحاجة فقط
- ضغط ملفات PDF
- معالجة الأخطاء بشكل صحيح

## استكشاف الأخطاء

### مشاكل شائعة
1. **العقد لا يظهر**: تأكد من وجود قالب العقد في قاعدة البيانات
2. **المتغيرات لا تستبدل**: تأكد من كتابة المتغيرات بالشكل الصحيح
3. **فشل رفع PDF**: تأكد من إعدادات الخادم وحجم الملف

### سجلات الأخطاء
راجع وحدة التحكم في المتصفح لمزيد من التفاصيل حول الأخطاء.

## المساهمة

لإضافة ميزات جديدة أو إصلاح أخطاء:
1. أنشئ فرع جديد
2. اعمل التغييرات المطلوبة
3. اختبر الوظائف
4. أرسل طلب دمج

---

تم تطوير هذا النظام لتسهيل إدارة عقود المضاربة وتوفير الوقت والجهد في إنشاء المستندات القانونية.
